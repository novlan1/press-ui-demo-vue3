import{P as t,K as e,a4 as s,l as i,O as n,N as a,a5 as o,a6 as c,_ as r,o as l,c as h,a as u,w as d,t as m,i as p,j as g,h as y,n as x,e as v,d as f,f as C}from"./index-ccbfbd02.js";import{a as b}from"./canvas.25858f9a.js";import{P as S}from"./press-image.9fd5b5ac.js";import{P as w,a as k}from"./press-grid-item.711cf5a9.js";import"./relation.8b10893c.js";import"./parent-map.7daf54ee.js";function P(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}function I(t,e,s,i,n,a,o,c,r){const l=[];let h,u,d,m,p;h=i-t,u=n-e,d=2*Math.sqrt(h*h+u*u+1e-4),h=h/d*s,u=u/d*s;const g=u,y=-h;m=i-o,p=n-c,d=2*Math.sqrt(m*m+p*p+1e-4),m=m/d*r,p=p/d*r;const x=-p,v=m;l.push({mx:t+g,my:e+y,color:"#1A1A1A"}),l.push({c1x:i+g,c1y:n+y,c2x:i+x,c2y:n+v,ex:o+x,ey:c+v}),l.push({c1x:o+x-m,c1y:c+v-p,c2x:o-x-m,c2y:c-v-p,ex:o-x,ey:c-v}),l.push({c1x:i-x,c1y:n-v,c2x:i-g,c2y:n-y,ex:t-g,ey:e-y}),l.push({c1x:t-g-h,c1y:e-y-u,c2x:t+g-h,c2y:e+y-u,ex:t+g,ey:e+y}),l[0].mx=l[0].mx.toFixed(1),l[0].mx=parseFloat(l[0].mx),l[0].my=l[0].my.toFixed(1),l[0].my=parseFloat(l[0].my);for(let f=1;f<l.length;f++)l[f].c1x=l[f].c1x.toFixed(1),l[f].c1x=parseFloat(l[f].c1x),l[f].c1y=l[f].c1y.toFixed(1),l[f].c1y=parseFloat(l[f].c1y),l[f].c2x=l[f].c2x.toFixed(1),l[f].c2x=parseFloat(l[f].c2x),l[f].c2y=l[f].c2y.toFixed(1),l[f].c2y=parseFloat(l[f].c2y),l[f].ex=l[f].ex.toFixed(1),l[f].ex=parseFloat(l[f].ex),l[f].ey=l[f].ey.toFixed(1),l[f].ey=parseFloat(l[f].ey);return l}function R(t,e,s,i){t.beginPath(),t.moveTo(e[0].mx,e[0].my),null!=i?(t.setFillStyle(i),t.setStrokeStyle(i)):(t.setFillStyle(e[0].color),t.setStrokeStyle(e[0].color));for(let n=1;n<e.length;n++)t.bezierCurveTo(e[n].c1x,e[n].c1y,e[n].c2x,e[n].c2y,e[n].ex,e[n].ey);t.stroke(),null!=s&&t.fill(),t.draw(!0)}let F=0;const T={name:"PressSignature",components:{PressButton:t},options:{styleIsolation:"shared"},props:{customClass:{type:String,default:""},tips:{type:String,default:""},type:{type:String,default:""},penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},backgroundColor:{type:String,default:"#fff"},clearButtonText:{type:String,default:e("clear")},confirmButtonText:{type:String,default:e("confirm")},fileType:{type:String,default:"jpg"}},emits:["start","signing","end","submit","clear"],data:()=>({canvasRect:{},canvasWidth:0,canvasHeight:0,id:1,inited:!1,ctx:null,wrapId:"pressSignatureWrap",currentLine:[],lastPoint:{},currentPoint:{},radius:1,canvas:null}),computed:{canvasId(){return`press-signature-${this.id}`},isRenderCanvas(){let t=!0;return t=!s||(()=>{var t;const e=document.createElement("canvas");return!!(null==(t=e.getContext)?void 0:t.call(e,"2d"))})(),t},useRawCanvas(){let t=!1;return t=!0,i()&&(t=!0),t}},watch:{windowWidth(){this.resize()}},created(){F+=1,this.id=F},mounted(){this.initialize()},methods:{touchStart(t){if(!this.ctx)return!1;this.useRawCanvas?(this.ctx.beginPath(),this.ctx.setLineWidth(this.lineWidth),this.ctx.setStrokeStyle(this.penColor)):this.updateCurrentLine(t,!0),n(this,`#${this.canvasId}`).then((t=>{this.canvasRect=t,this.$emit("start")}))},pointToLine(t){const e=function(t,e,{lineColor:s="#1A1A1A",updateRadius:i,radius:n}){let a=n;if(e.length<=1)return void(e[0].r=a);let o,c,r,l,h,u,d=0,m=0;const p=.5;e.length<=2?(o=e[1].x,l=e[1].y,r=e[1].x+(e[0].x-e[1].x)*p,u=e[1].y+(e[0].y-e[1].y)*p,c=o+(r-o)*p,h=l+(u-l)*p):(o=e[2].x+(e[1].x-e[2].x)*p,l=e[2].y+(e[1].y-e[2].y)*p,c=e[1].x,h=e[1].y,r=c+(e[0].x-c)*p,u=h+(e[0].y-h)*p);const g=P({x:r,y:u},{x:o,y:l}),y=a;for(let v=0;v<e.length-1&&(d+=e[v].dis,m+=e[v].time-e[v+1].time,!(d>60));v++);a=1.5*Math.min(m/g*1+.5,4),i(a),e[0].r=a;let x=[];for(let v=0;v<5;v++){const e=v/4,i=(1-e)*(1-e)*o+2*e*(1-e)*c+e*e*r,n=(1-e)*(1-e)*l+2*e*(1-e)*h+e*e*u,d=y+(a-y)/5*v;if(x.push({x:i,y:n,r:d}),3==x.length){const e=I(x[0].x,x[0].y,x[0].r,x[1].x,x[1].y,x[1].r,x[2].x,x[2].y,x[2].r);e[0].color=s,R(t,e,1),x=[{x:i,y:n,r:d}]}}return e}(this.ctx,t,{lineColor:this.penColor,updateRadius:t=>{this.radius=t},radius:this.radius,lineWidth:this.lineWidth,penColor:this.penColor});e&&(this.currentLine=e)},updateCurrentLine(t,e=!1){const s={x:t.changedTouches[0].x,y:t.changedTouches[0].y};this.lastPoint=this.currentPoint,this.currentPoint=s;const{currentLine:i}=this;i.unshift({time:(new Date).getTime(),dis:e?0:P(this.currentPoint,this.lastPoint),x:s.x,y:s.y}),this.pointToLine(i)},touchMove(t){var e,s,i,n;if(!this.ctx)return!1;if(null==(e=t.preventDefault)||e.call(t),null==(s=t.stopPropagation)||s.call(t),this.useRawCanvas){const e=t.touches[0],s=e.clientX-((null==(i=this.canvasRect)?void 0:i.left)||0),c=a(e.clientY)-((null==(n=this.canvasRect)?void 0:n.top)||0);this.ctx.setLineCap("round"),this.ctx.setLineJoin("round"),this.ctx.lineTo(s,c),this.ctx.stroke(),o()||this.ctx.draw(!0)}else this.updateCurrentLine(t);this.$emit("signing",t)},touchEnd(t){var e;null==(e=t.preventDefault)||e.call(t),this.$emit("end"),this.useRawCanvas||(this.updateCurrentLine(t),this.currentLine=[])},submit(){var t,e;const s=this;if(this.useRawCanvas){const s=this.$refs.canvasRef;if(!s)return;const i=this.isCanvasEmpty(s)?"":(null==(e=(t={jpg:()=>s.toDataURL("image/jpeg",.8),jpeg:()=>s.toDataURL("image/jpeg",.8)})[this.type])?void 0:e.call(t))||s.toDataURL(`image/${this.type}`);this.$emit("submit",{image:i,canvas:s,width:this.canvasWidth,height:this.canvasHeight})}else{(()=>{uni.canvasToTempFilePath({canvas:this.canvas,canvasId:this.canvasId,fileType:this.fileType,quality:1,success(t){const e=t.tempFilePath;s.base64(e,"jpg").then((t=>{s.$emit("submit",{image:t,canvas:s.canvas,width:s.canvasWidth,height:s.canvasHeight})}))},fail(t){console.warn("[canvasToTempFilePath] error: ",t)}},this)})()}},base64:(t,e)=>new Promise(((s,i)=>{uni.getFileSystemManager().readFile({filePath:t,encoding:"base64",success(t){s(`data:image/${e.toLocaleLowerCase()};base64,${t.data}`)},fail(){i()}})})),innerClear(){this.ctx&&(this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.closePath(),this.ctx.draw(),this.setCanvasBgColor(this.ctx))},clear(){this.innerClear(),this.$emit("clear")},initialize(){this.isRenderCanvas&&this.getContext().then((t=>{this.ctx=t,this.innerClear()}))},getContext(){const t=this;return new Promise(((e,s)=>{n(this,`#${this.wrapId}`).then((s=>{const{width:i,height:n}=s;t.canvasWidth=i,t.canvasHeight=n;const a=t.innerGetContext({width:i,height:n});e(a)})).catch((t=>{s(t)}))}))},innerGetContext({width:t,height:e}){const s=()=>{const s=window.devicePixelRatio,i=document.getElementById(this.canvasId),n=i.getContext("2d");return this.inited||(this.inited=!0,i.width=t*s,i.height=e*s,n.scale(s,s)),Promise.resolve(b(n))};if(this.useRawCanvas)return s();if(!o()){const t=uni.createCanvasContext(this.canvasId,this);return this.inited=!0,t.scale(i,i),Promise.resolve(t)}const i=c().pixelRatio;return new Promise((s=>{uni.createSelectorQuery().in(this).select(`#${this.canvasId}`).node().exec((n=>{const a=n[0].node;this.canvas=a;const o=a.getContext("2d");this.inited||(this.inited=!0,a.width=t*i,a.height=e*i,o.scale(i,i)),s(b(o))}))}))},resize(){if(this.ctx){const t=this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight);this.initialize(),this.ctx.putImageData(t,0,0)}},isCanvasEmpty(t){const e=document.createElement("canvas");if(e.width=t.width,e.height=t.height,this.backgroundColor){const t=e.getContext("2d");this.setCanvasBgColor(t)}return t.toDataURL()===e.toDataURL()},setCanvasBgColor(t){var e,s;t&&this.backgroundColor&&(t.fillStyle=this.backgroundColor,null==(e=t.setFillStyle)||e.call(t,this.backgroundColor),t.fillRect(0,0,this.canvasWidth,this.canvasHeight),null==(s=t.draw)||s.call(t))},t:e}};const W={"pen-color":"#000","line-width":3,"background-color":"#fff"};const L=r({i18n:{"zh-CN":{penColor:"自定义颜色",lineWidth:"自定义线宽",backgroundColor:"自定义背景颜色"},"en-US":{penColor:"Pen Color",lineWidth:"Line Width",backgroundColor:"Background Color"}},components:{PressSignature:r(T,[["render",function(t,e,s,i,n,a){const o=v("PressButton");return l(),h("div",{class:x(["press-signature",s.customClass])},[u("div",{id:n.wrapId,ref:"wrapRef",class:"press-signature__content"},[a.isRenderCanvas?(l(),h("Canvas",{key:0,id:a.canvasId,ref:"canvasRef",type:"2d","canvas-id":a.canvasId,onTouchstartPassive:e[0]||(e[0]=(...t)=>a.touchStart&&a.touchStart(...t)),onTouchmove:e[1]||(e[1]=d(((...t)=>a.touchMove&&a.touchMove(...t)),["prevent","stop"])),onTouchend:e[2]||(e[2]=d(((...t)=>a.touchEnd&&a.touchEnd(...t)),["prevent","stop"]))},null,40,["id","canvas-id"])):(l(),h("p",{key:1},m(s.tips),1))],8,["id"]),u("div",{class:"press-signature__footer"},[p(o,{"custom-class":"press-signature__button press-signature__button--clear",size:"small",onClick:a.clear},{default:g((()=>[y(m(s.clearButtonText||a.t("clear")),1)])),_:1},8,["onClick"]),p(o,{"custom-class":"press-signature__button press-signature__submit",type:"primary",size:"small",onClick:a.submit},{default:g((()=>[y(m(s.confirmButtonText||a.t("confirm")),1)])),_:1},8,["onClick"])])],2)}],["__scopeId","data-v-ea2c29da"]]),PressImage:S,PressGrid:w,PressGridItem:k},data:()=>({image:"",canvasWidth:"calc(100vw - 16px)",canvasHeight:200,customStyle:"background: transparent",sectionStyle:"padding: 0 0",customInfo:{...W}}),methods:{onSubmit(t){console.log("[onSubmit]",t);const{image:e,width:s,height:i}=t;this.image=e,this.canvasWidth=s,this.canvasHeight=i},onClear(){},custom(t){this.customInfo={...W,...t},setTimeout((()=>{this.$refs.pressSignature.clear()}))}}},[["render",function(t,e,s,i,n,a){const o=v("PressSignature"),c=v("PressImage"),r=v("demo-block"),d=v("PressGridItem"),m=v("PressGrid");return l(),h("div",{class:"demo-wrap"},[p(r,{title:t.t("basicUsage"),"section-style":n.sectionStyle,"custom-style":n.customStyle},{default:g((()=>[p(o,{ref:"pressSignature","pen-color":n.customInfo["pen-color"],"line-width":n.customInfo["line-width"],"background-color":n.customInfo["background-color"],onSubmit:a.onSubmit,onClear:a.onClear},null,8,["pen-color","line-width","background-color","onSubmit","onClear"]),u("div",{class:"image-wrap"},[n.image?(l(),C(c,{key:0,src:n.image,width:n.canvasWidth,height:n.canvasHeight},null,8,["src","width","height"])):f("v-if",!0)])])),_:1},8,["title","section-style","custom-style"]),f(' <demo-block\n      :title="t(\'penColor\')"\n      :section-style="sectionStyle"\n      :custom-style="customStyle"\n    >\n      <PressSignature\n        pen-color="#ff0000"\n        @submit="onSubmit"\n        @clear="onClear"\n      />\n    </demo-block>\n\n    <demo-block\n      :title="t(\'lineWidth\')"\n      :section-style="sectionStyle"\n      :custom-style="customStyle"\n    >\n      <PressSignature\n        :line-width="6"\n        @submit="onSubmit"\n        @clear="onClear"\n      />\n    </demo-block>\n\n    <demo-block\n      :title="t(\'backgroundColor\')"\n      :section-style="sectionStyle"\n      :custom-style="customStyle"\n    >\n      <PressSignature\n        background-color="#eee"\n        @submit="onSubmit"\n        @clear="onClear"\n      />\n    </demo-block> '),p(m,{clickable:"","column-num":3},{default:g((()=>[p(d,{text:t.t("penColor"),icon:"edit",onClick:e[0]||(e[0]=t=>a.custom({"pen-color":"#ff0000"}))},null,8,["text"]),p(d,{text:t.t("lineWidth"),icon:"font-o",onClick:e[1]||(e[1]=t=>a.custom({"line-width":6}))},null,8,["text"]),p(d,{text:t.t("backgroundColor"),icon:"photo-o",onClick:e[2]||(e[2]=t=>a.custom({"background-color":"#eee"}))},null,8,["text"])])),_:1})])}],["__scopeId","data-v-4afa9c71"]]);export{L as default};

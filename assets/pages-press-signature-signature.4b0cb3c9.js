import{P as t,a as e}from"./press-grid.b3d6f828.js";import{P as s}from"./press-image.5b36e044.js";import{P as i,K as n,a4 as a,l as o,O as c,N as r,a5 as l,a6 as h,_ as u,o as d,c as m,f as p,w as g,t as x,i as v,j as y,h as f,n as C,r as w,d as b,b as S}from"./index-d9d977eb.js";import{a as P}from"./canvas.25858f9a.js";import"./parent-map.7daf54ee.js";import"./relation.8b10893c.js";function k(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}function I(t,e,s,i,n,a,o,c,r){const l=[];let h,u,d,m,p;h=i-t,u=n-e,d=2*Math.sqrt(h*h+u*u+1e-4),h=h/d*s,u=u/d*s;const g=u,x=-h;m=i-o,p=n-c,d=2*Math.sqrt(m*m+p*p+1e-4),m=m/d*r,p=p/d*r;const v=-p,y=m;l.push({mx:t+g,my:e+x,color:"#1A1A1A"}),l.push({c1x:i+g,c1y:n+x,c2x:i+v,c2y:n+y,ex:o+v,ey:c+y}),l.push({c1x:o+v-m,c1y:c+y-p,c2x:o-v-m,c2y:c-y-p,ex:o-v,ey:c-y}),l.push({c1x:i-v,c1y:n-y,c2x:i-g,c2y:n-x,ex:t-g,ey:e-x}),l.push({c1x:t-g-h,c1y:e-x-u,c2x:t+g-h,c2y:e+x-u,ex:t+g,ey:e+x}),l[0].mx=l[0].mx.toFixed(1),l[0].mx=parseFloat(l[0].mx),l[0].my=l[0].my.toFixed(1),l[0].my=parseFloat(l[0].my);for(let f=1;f<l.length;f++)l[f].c1x=l[f].c1x.toFixed(1),l[f].c1x=parseFloat(l[f].c1x),l[f].c1y=l[f].c1y.toFixed(1),l[f].c1y=parseFloat(l[f].c1y),l[f].c2x=l[f].c2x.toFixed(1),l[f].c2x=parseFloat(l[f].c2x),l[f].c2y=l[f].c2y.toFixed(1),l[f].c2y=parseFloat(l[f].c2y),l[f].ex=l[f].ex.toFixed(1),l[f].ex=parseFloat(l[f].ex),l[f].ey=l[f].ey.toFixed(1),l[f].ey=parseFloat(l[f].ey);return l}function R(t,e,s,i){t.beginPath(),t.moveTo(e[0].mx,e[0].my),null!=i?(t.setFillStyle(i),t.setStrokeStyle(i)):(t.setFillStyle(e[0].color),t.setStrokeStyle(e[0].color));for(let n=1;n<e.length;n++)t.bezierCurveTo(e[n].c1x,e[n].c1y,e[n].c2x,e[n].c2y,e[n].ex,e[n].ey);t.stroke(),null!=s&&t.fill(),t.draw(!0)}let F=0;const T={name:"PressSignature",components:{PressButton:i},options:{styleIsolation:"shared"},props:{customClass:{type:String,default:""},tips:{type:String,default:""},type:{type:String,default:""},penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},backgroundColor:{type:String,default:"#fff"},clearButtonText:{type:String,default:n("clear")},confirmButtonText:{type:String,default:n("confirm")},fileType:{type:String,default:"jpg"}},emits:["start","signing","end","submit","clear"],data:()=>({canvasRect:{},canvasWidth:0,canvasHeight:0,id:1,inited:!1,ctx:null,wrapId:"pressSignatureWrap",currentLine:[],lastPoint:{},currentPoint:{},radius:1,canvas:null}),computed:{canvasId(){return`press-signature-${this.id}`},isRenderCanvas(){let t=!0;return t=!a||(()=>{var t;const e=document.createElement("canvas");return!!(null==(t=e.getContext)?void 0:t.call(e,"2d"))})(),t},useRawCanvas(){let t=!1;return t=!0,o()&&(t=!0),t}},watch:{windowWidth(){this.resize()}},created(){F+=1,this.id=F},mounted(){this.initialize()},methods:{touchStart(t){if(!this.ctx)return!1;this.useRawCanvas?(this.ctx.beginPath(),this.ctx.setLineWidth(this.lineWidth),this.ctx.setStrokeStyle(this.penColor)):this.updateCurrentLine(t,!0),c(this,`#${this.canvasId}`).then((t=>{this.canvasRect=t,this.$emit("start")}))},pointToLine(t){const e=function(t,e,{lineColor:s="#1A1A1A",updateRadius:i,radius:n}){let a=n;if(e.length<=1)return void(e[0].r=a);let o,c,r,l,h,u,d=0,m=0;const p=.5;e.length<=2?(o=e[1].x,l=e[1].y,r=e[1].x+(e[0].x-e[1].x)*p,u=e[1].y+(e[0].y-e[1].y)*p,c=o+(r-o)*p,h=l+(u-l)*p):(o=e[2].x+(e[1].x-e[2].x)*p,l=e[2].y+(e[1].y-e[2].y)*p,c=e[1].x,h=e[1].y,r=c+(e[0].x-c)*p,u=h+(e[0].y-h)*p);const g=k({x:r,y:u},{x:o,y:l}),x=a;for(let y=0;y<e.length-1&&(d+=e[y].dis,m+=e[y].time-e[y+1].time,!(d>60));y++);a=1.5*Math.min(m/g*1+.5,4),i(a),e[0].r=a;let v=[];for(let y=0;y<5;y++){const e=y/4,i=(1-e)*(1-e)*o+2*e*(1-e)*c+e*e*r,n=(1-e)*(1-e)*l+2*e*(1-e)*h+e*e*u,d=x+(a-x)/5*y;if(v.push({x:i,y:n,r:d}),3==v.length){const e=I(v[0].x,v[0].y,v[0].r,v[1].x,v[1].y,v[1].r,v[2].x,v[2].y,v[2].r);e[0].color=s,R(t,e,1),v=[{x:i,y:n,r:d}]}}return e}(this.ctx,t,{lineColor:this.penColor,updateRadius:t=>{this.radius=t},radius:this.radius,lineWidth:this.lineWidth,penColor:this.penColor});e&&(this.currentLine=e)},updateCurrentLine(t,e=!1){const s={x:t.changedTouches[0].x,y:t.changedTouches[0].y};this.lastPoint=this.currentPoint,this.currentPoint=s;const{currentLine:i}=this;i.unshift({time:(new Date).getTime(),dis:e?0:k(this.currentPoint,this.lastPoint),x:s.x,y:s.y}),this.pointToLine(i)},touchMove(t){var e,s,i,n;if(!this.ctx)return!1;if(null==(e=t.preventDefault)||e.call(t),null==(s=t.stopPropagation)||s.call(t),this.useRawCanvas){const e=t.touches[0],s=e.clientX-((null==(i=this.canvasRect)?void 0:i.left)||0),a=r(e.clientY)-((null==(n=this.canvasRect)?void 0:n.top)||0);this.ctx.setLineCap("round"),this.ctx.setLineJoin("round"),this.ctx.lineTo(s,a),this.ctx.stroke(),l()||this.ctx.draw(!0)}else this.updateCurrentLine(t);this.$emit("signing",t)},touchEnd(t){var e;null==(e=t.preventDefault)||e.call(t),this.$emit("end"),this.useRawCanvas||(this.updateCurrentLine(t),this.currentLine=[])},submit(){var t,e;const s=this;if(this.useRawCanvas){const s=this.$refs.canvasRef;if(!s)return;const i=this.isCanvasEmpty(s)?"":(null==(e=(t={jpg:()=>s.toDataURL("image/jpeg",.8),jpeg:()=>s.toDataURL("image/jpeg",.8)})[this.type])?void 0:e.call(t))||s.toDataURL(`image/${this.type}`);this.$emit("submit",{image:i,canvas:s,width:this.canvasWidth,height:this.canvasHeight})}else{(()=>{uni.canvasToTempFilePath({canvas:this.canvas,canvasId:this.canvasId,fileType:this.fileType,quality:1,success(t){const e=t.tempFilePath;s.base64(e,"jpg").then((t=>{s.$emit("submit",{image:t,canvas:s.canvas,width:s.canvasWidth,height:s.canvasHeight})}))},fail(t){console.warn("[canvasToTempFilePath] error: ",t)}},this)})()}},base64:(t,e)=>new Promise(((s,i)=>{uni.getFileSystemManager().readFile({filePath:t,encoding:"base64",success(t){s(`data:image/${e.toLocaleLowerCase()};base64,${t.data}`)},fail(){i()}})})),innerClear(){this.ctx&&(this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.closePath(),this.ctx.draw(),this.setCanvasBgColor(this.ctx))},clear(){this.innerClear(),this.$emit("clear")},initialize(){this.isRenderCanvas&&this.getContext().then((t=>{this.ctx=t,this.innerClear()}))},getContext(){const t=this;return new Promise(((e,s)=>{c(this,`#${this.wrapId}`).then((s=>{const{width:i,height:n}=s;t.canvasWidth=i,t.canvasHeight=n;const a=t.innerGetContext({width:i,height:n});e(a)})).catch((t=>{s(t)}))}))},innerGetContext({width:t,height:e}){const s=()=>{const s=window.devicePixelRatio,i=document.getElementById(this.canvasId),n=i.getContext("2d");return this.inited||(this.inited=!0,i.width=t*s,i.height=e*s,n.scale(s,s)),Promise.resolve(P(n))};if(this.useRawCanvas)return s();if(!l()){const t=uni.createCanvasContext(this.canvasId,this);return this.inited=!0,t.scale(i,i),Promise.resolve(t)}const i=h().pixelRatio;return new Promise((s=>{uni.createSelectorQuery().in(this).select(`#${this.canvasId}`).node().exec((n=>{const a=n[0].node;this.canvas=a;const o=a.getContext("2d");this.inited||(this.inited=!0,a.width=t*i,a.height=e*i,o.scale(i,i)),s(P(o))}))}))},resize(){if(this.ctx){const t=this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight);this.initialize(),this.ctx.putImageData(t,0,0)}},isCanvasEmpty(t){const e=document.createElement("canvas");if(e.width=t.width,e.height=t.height,this.backgroundColor){const t=e.getContext("2d");this.setCanvasBgColor(t)}return t.toDataURL()===e.toDataURL()},setCanvasBgColor(t){var e,s;t&&this.backgroundColor&&(t.fillStyle=this.backgroundColor,null==(e=t.setFillStyle)||e.call(t,this.backgroundColor),t.fillRect(0,0,this.canvasWidth,this.canvasHeight),null==(s=t.draw)||s.call(t))},t:n}};const L={"pen-color":"#000","line-width":3,"background-color":"#fff"};const W=u({i18n:{"zh-CN":{penColor:"自定义颜色",lineWidth:"自定义线宽",backgroundColor:"自定义背景颜色"},"en-US":{penColor:"Pen Color",lineWidth:"Line Width",backgroundColor:"Background Color"}},components:{PressSignature:u(T,[["render",function(t,e,s,i,n,a){const o=w("PressButton");return d(),m("div",{class:C(["press-signature",s.customClass])},[p("div",{id:n.wrapId,ref:"wrapRef",class:"press-signature__content"},[a.isRenderCanvas?(d(),m("Canvas",{key:0,id:a.canvasId,ref:"canvasRef",type:"2d","canvas-id":a.canvasId,onTouchstartPassive:e[0]||(e[0]=(...t)=>a.touchStart&&a.touchStart(...t)),onTouchmove:e[1]||(e[1]=g(((...t)=>a.touchMove&&a.touchMove(...t)),["prevent","stop"])),onTouchend:e[2]||(e[2]=g(((...t)=>a.touchEnd&&a.touchEnd(...t)),["prevent","stop"]))},null,40,["id","canvas-id"])):(d(),m("p",{key:1},x(s.tips),1))],8,["id"]),p("div",{class:"press-signature__footer"},[v(o,{"custom-class":"press-signature__button press-signature__button--clear",size:"small",onClick:a.clear},{default:y((()=>[f(x(s.clearButtonText||a.t("clear")),1)])),_:1},8,["onClick"]),v(o,{"custom-class":"press-signature__button press-signature__submit",type:"primary",size:"small",onClick:a.submit},{default:y((()=>[f(x(s.confirmButtonText||a.t("confirm")),1)])),_:1},8,["onClick"])])],2)}],["__scopeId","data-v-46c2c4ad"]]),PressImage:s,PressGrid:t,PressGridItem:e},data:()=>({image:"",canvasWidth:"calc(100vw - 16px)",canvasHeight:200,customStyle:"background: transparent",sectionStyle:"padding: 0 0",customInfo:{...L}}),methods:{onSubmit(t){console.log("[onSubmit]",t);const{image:e,width:s,height:i}=t;this.image=e,this.canvasWidth=s,this.canvasHeight=i},onClear(){},custom(t){this.customInfo={...L,...t},setTimeout((()=>{this.$refs.pressSignature.clear()}))}}},[["render",function(t,e,s,i,n,a){const o=w("PressSignature"),c=w("PressImage"),r=w("demo-block"),l=w("PressGridItem"),h=w("PressGrid");return d(),m("div",{class:"demo-wrap"},[v(r,{title:t.t("basicUsage"),"section-style":n.sectionStyle,"custom-style":n.customStyle},{default:y((()=>[v(o,{ref:"pressSignature","pen-color":n.customInfo["pen-color"],"line-width":n.customInfo["line-width"],"background-color":n.customInfo["background-color"],onSubmit:a.onSubmit,onClear:a.onClear},null,8,["pen-color","line-width","background-color","onSubmit","onClear"]),p("div",{class:"image-wrap"},[n.image?(d(),b(c,{key:0,src:n.image,width:n.canvasWidth,height:n.canvasHeight},null,8,["src","width","height"])):S("v-if",!0)])])),_:1},8,["title","section-style","custom-style"]),v(h,{clickable:"","column-num":3},{default:y((()=>[v(l,{text:t.t("penColor"),icon:"edit",onClick:e[0]||(e[0]=t=>a.custom({"pen-color":"#ff0000"}))},null,8,["text"]),v(l,{text:t.t("lineWidth"),icon:"font-o",onClick:e[1]||(e[1]=t=>a.custom({"line-width":6}))},null,8,["text"]),v(l,{text:t.t("backgroundColor"),icon:"photo-o",onClick:e[2]||(e[2]=t=>a.custom({"background-color":"#eee"}))},null,8,["text"])])),_:1})])}],["__scopeId","data-v-8eb5f4d1"]]);export{W as default};
